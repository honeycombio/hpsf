kind: EMAThroughputSampler
name: Sample by Events per Second
version: v0.1.0
style: sampler
type: base
status: beta
summary: |-
  An Exponential Moving Average (EMA) sampler designed to achieve a target throughput (in events per
  second).
description: |-
  This is an Exponential Moving Average (EMA) sampler designed to achieve a target throughput (in
  events per second) based on trying to achieve representative quantities of the specified sampling
  keys. The keys should be chosen from fields with relatively low cardinality, such as HTTP method,
  status code, etc.
tags:
  - category:sampler
  - service:refinery
  - signal:HoneycombEvents
  - sampler:ema
  - sampler:throughput
  - input:SampleData
  - output:Events
ports:
  # inputs
  - name: Sample
    direction: input
    type: SampleData
  # outputs
  - name: Events
    direction: output
    type: HoneycombEvents
    note: "The traces that are sampled (retained for further processing)"
properties:
  - name: GoalThroughputPerSec
    display: Goal Throughput Per Sec
    summary: The target throughput to achieve (in events per second).
    description: |
      The desired throughput to achieve (in events per second, NOT traces
      per second). Note that this is a target, and the actual throughput may
      vary. The accuracy of this sampler is heavily dependent on 1. the type
      and volume of traffic; 2. the cardinality and distribution of the
      sampling keys per AdjustmentInterval; 3. the AdjustmentInterval.
    type: int
    validations:
      - positive
    default: 100
  - name: AdjustmentInterval
    display: Adjustment Interval
    summary: The interval (in seconds) between adjustments of the sampling rate
    description: |
      The interval (in seconds) at which to adjust the sampling rate. This
      is the time window over which the sampler will adjust the sampling
      rate to try to achieve the target throughput. The smaller the
      interval, the more responsive the sampler will be to changes in
      traffic patterns, but the more volatile the sampling rate will be.
    type: int
    validations:
      - positive
    default: 60
    advanced: true
  - name: FieldList
    display: Field List
    summary: The field names of the keys to use for controlling sampling
    description: |
      The field names of keys to use for sampling. These should be chosen
      from fields with relatively low cardinality, such as HTTP method,
      status code, etc. The sampler will try to achieve representative
      quantities of the specified sampling keys, while ensuring that at least
      one instance of every distinct value of each key is sampled.
      There is no default; this field must be specified.
    type: stringarray
    validations:
      - noblanks
      - nonempty
    default: []
  - name: InitialSampleRate
    display: Initial Sample Rate
    summary: The initial sample rate to use when starting the sampler
    description: |
      The initial sample rate to use when starting the sampler. This is the
      sample rate that will be used before any adjustments are made based on
      the observed throughput.
      The default value is 10.
    type: int
    validations:
      - positive
    default: 10
    advanced: true
  - name: MaxKeys
    display: Max Keys
    summary: The maximum number of distinct keys the sampler tracks
    description: |
      The maximum number of distinct keys the sampler tracks. This is used to limit
      the number of keys that are retained in the sampler's state that is used to
      compute the sampling rate.
      The default value is 500.
    type: int
    validations:
      - positive
    default: 500
    advanced: true
templates:
  - kind: refinery_rules
    name: EMA_Throughput_Rules
    format: rules
    meta:
      env: "__default__"
      sampler: EMAThroughputSampler
    data:
      - key: GoalThroughputPerSec
        value: "{{ .Values.GoalThroughputPerSec | encodeAsInt }}"
      - key: FieldList
        value: "{{ .Values.FieldList | encodeAsArray }}"
      # properties are suppressed if defaults are used
      - key: AdjustmentInterval
        value: "{{ .Values.AdjustmentInterval }}s"
        suppress_if: "{{ eq .Values.AdjustmentInterval 60 }}"
      - key: InitialSampleRate
        value: "{{ .Values.InitialSampleRate | encodeAsInt }}"
        suppress_if: "{{ eq .Values.InitialSampleRate 10 }}"
      - key: MaxKeys
        value: "{{ .Values.MaxKeys | encodeAsInt }}"
        suppress_if: "{{ eq .Values.MaxKeys 500 }}"
      # always enable use cluster size
      - key: UseClusterSize
        value: true
