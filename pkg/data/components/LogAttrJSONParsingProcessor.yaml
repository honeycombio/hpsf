kind: LogAttrJSONParsingProcessor
name: Parse Log Attribute as JSON
style: processor
type: base
status: alpha
version: v0.0.1
summary: Converts a log attribute's JSON string value into individual attributes
description: Specify a log attribute with a JSON string value to parse into individual attributes on the log record. If the attribute is not found or cannot be parsed as JSON, the log will continue through the pipeline unchanged.
tags:
  - category:processor
  - service:collector
  - signal:OTelLogs
  - input:Logs
  - output:Logs
ports:
  # inputs
  - name: Logs
    direction: input
    type: OTelLogs
  # outputs
  - name: Logs
    direction: output
    type: OTelLogs
properties:
  - name: Attribute
    type: string
    validations:
      - noblanks
templates:
  - kind: collector_config
    name: otel_filter
    format: collector
    meta:
      componentSection: processors
      signalTypes: [logs]
      collectorComponentName: transform
    data:
      - key: "{{ .ComponentName }}.error_mode"
        value: "ignore"
      - key: "{{ .ComponentName }}.log_statements[0].conditions[0]"
        value: "log.attributes[\"{{ .Values.Attribute }}\"] != nil and HasPrefix(log.attributes[\"{{ .Values.Attribute }}\"], \"{\")"
      - key: "{{ .ComponentName }}.log_statements[0].statements[0]"
        value: "set(log.cache, ParseJSON(log.attributes[\"{{ .Values.Attribute }}\"]))"
      - key: "{{ .ComponentName }}.log_statements[0].statements[1]"
        value: "flatten(log.cache, \"\")"
      - key: "{{ .ComponentName }}.log_statements[0].statements[2]"
        value: "merge_maps(log.attributes, log.cache, \"upsert\")"
