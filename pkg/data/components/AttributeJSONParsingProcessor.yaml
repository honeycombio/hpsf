kind: AttributeJSONParsingProcessor
name: Parse Attribute As JSON
style: processor
type: base
status: alpha
version: v0.0.1
summary: Converts an Attribute's JSON string value into individual attributes
description: Takes any attribute from a log or span and parses it as JSON into individual attributes
tags:
  - category:processor
  - service:collector
  - signal:OTelTraces
  - signal:OTelLogs
  - input:Traces
  - input:Logs
  - output:Traces
  - output:Logs
ports:
  # inputs
  - name: Traces
    direction: input
    type: OTelTraces
  - name: Logs
    direction: input
    type: OTelLogs
  # outputs
  - name: Traces
    direction: output
    type: OTelTraces
  - name: Logs
    direction: output
    type: OTelLogs
properties:
  - name: Attribute
    type: string
    validations:
      - noblanks
templates:
  - kind: collector_config
    name: otel_filter
    format: collector
    meta:
      componentSection: processors
      signalTypes: [logs, traces]
      collectorComponentName: transform
    data:
      - key: "{{ .ComponentName }}.error_mode"
        value: "ignore"
      - key: "{{ .ComponentName }}.trace_statements[0].conditions[0]"
        value: "span.attributes[\"{{ .Values.Attribute }}\"] != nil and HasPrefix(span.attributes[\"{{ .Values.Attribute }}\"], \"{\")"
        suppress_if: '{{ not .HasTracesConnection }}'
      - key: "{{ .ComponentName }}.trace_statements[0].statements[0]"
        value: "set(span.cache, ParseJSON(span.attributes[\"{{ .Values.Attribute }}\"]))"
        suppress_if: '{{ not .HasTracesConnection }}'
      - key: "{{ .ComponentName }}.trace_statements[0].statements[1]"
        value: "flatten(span.cache, \"\")"
        suppress_if: '{{ not .HasTracesConnection }}'
      - key: "{{ .ComponentName }}.trace_statements[0].statements[2]"
        value: "merge_maps(span.attributes, span.cache, \"upsert\")"
        suppress_if: '{{ not .HasTracesConnection }}'
      - key: "{{ .ComponentName }}.log_statements[0].conditions[0]"
        value: "log.attributes[\"{{ .Values.Attribute }}\"] != nil and HasPrefix(log.attributes[\"{{ .Values.Attribute }}\"], \"{\")"
        suppress_if: '{{ not .HasLogsConnection }}'
      - key: "{{ .ComponentName }}.log_statements[0].statements[0]"
        value: "set(log.cache, ParseJSON(log.attributes[\"{{ .Values.Attribute }}\"]))"
        suppress_if: '{{ not .HasLogsConnection }}'
      - key: "{{ .ComponentName }}.log_statements[0].statements[1]"
        value: "flatten(log.cache, \"\")"
        suppress_if: '{{ not .HasLogsConnection }}'
      - key: "{{ .ComponentName }}.log_statements[0].statements[2]"
        value: "merge_maps(log.attributes, log.cache, \"upsert\")"
        suppress_if: '{{ not .HasLogsConnection }}'
