kind: HTTPStatusCodeCondition
name: Check HTTP Status Code
style: condition
type: base
status: development
version: v0.1.0
summary: Set sample rate by HTTP status code range
description: |-
  Sample based on the http status of processes within a trace. If any spans of a trace have a status code within the selected min and max, the condition will evaluate to true. 
tags:
  - category:refinery_rule
  - service:refinery
  - vendor:Honeycomb
  - type:error
  - input:SampleData
  - output:SampleData
ports:
  # inputs
  - name: Match
    direction: input
    type: SampleData
  # outputs
  - name: And
    direction: output
    type: SampleData
properties:
  - name: Minimum
    display: Minimum
    summary: The lower bound of the target status code range (inclusive)
    description: |
      The minimum HTTP status code to compare against. This is often 400 or 500.
    type: int
    default: 400
    validations:
      - inrange(100, 599)
  - name: Maximum
    display: Maximum
    summary: The upper bound of the target status code range (inclusive)
    description: |
      The maximum HTTP status code to compare against. This is often 499 or 599.
    type: int
    default: 599
    validations:
      - inrange(100, 599)
  - name: Fields
    display: Fields
    summary: The name of the field(s) to check for HTTP status code values
    description: |
      The HTTP status code fields to check. Typically these are "http.status_code" and "http.response.status_code".
    type: stringarray
    default: ["http.status_code", "http.response.status_code"]
    validations:
      - nonempty
    advanced: true
validations:
  - less_than_or_equal(Minimum, Maximum)
templates:
  - kind: refinery_rules
    name: HTTPStatusCodeCondition
    format: rules
    meta:
      condition: true
    data:
      - key: Fields.1
        value: "{{ .Values.Fields | encodeAsArray }}"
      - key: Operator.1
        value: ">="
      - key: Value.1
        value: "{{ .Values.Minimum | encodeAsInt }}"
      - key: Datatype.1
        value: int
      - key: Fields.2
        value: "{{ .Values.Fields | encodeAsArray }}"
      - key: Operator.2
        value: "<="
      - key: Value.2
        value: "{{ .Values.Maximum | encodeAsInt }}"
      - key: Datatype.2
        value: int
