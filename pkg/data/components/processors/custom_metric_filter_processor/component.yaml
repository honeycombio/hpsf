kind: CustomMetricFilterProcessor
name: Filter Metrics by Custom OTTL
style: processor
type: base
status: development
version: v0.1.0
summary: Filters metrics using custom OTTL statements (advanced)
description: |
  Apply custom filters to metrics and metric data points using configuration statements written in OpenTelemetry
  Transformation Language (OTTL). This is an advanced component. No OTTL validation is provided.
tags:
  - category:processor
  - service:collector
  - signal:OTelMetrics
  - input:Metrics
  - output:Metrics
ports:
  # inputs
  - name: Metrics
    direction: input
    type: OTelMetrics
  # outputs
  - name: Metrics
    direction: output
    type: OTelMetrics
properties:
  - name: ErrorMode
    display: Error Mode
    type: string
    subtype: oneof(ignore, propagate)
    default: ignore
    summary: How to handle errors during filtering
    description: |
      Controls how the processor handles errors during filtering:
      - ignore: Log errors but continue processing
      - propagate: Stop processing and return the error
    validations:
      - oneof(ignore, propagate)
  - name: MetricStatements
    display: Metric Filter Statements
    type: stringarray
    summary: OTTL metric filter statements
    description: |
      OpenTelemetry Transformation Language (OTTL) statements for filtering metrics.
      Examples:
      - 'name == "http.server.duration"'
      - 'type == METRIC_DATA_TYPE_SUM'
  - name: DataPointStatements
    display: Data Point Filter Statements
    type: stringarray
    summary: OTTL metric data point filter statements
    description: |
      OpenTelemetry Transformation Language (OTTL) statements for filtering metric data points.
      Examples:
      - 'attributes["service.name"] == "api"'
      - 'metric.type == METRIC_DATA_TYPE_GAUGE'
validations:
  - "at_least_one_of(MetricStatements, DataPointStatements)"
templates:
  - kind: collector_config
    name: filter_processor
    format: collector
    meta:
      componentSection: processors
      signalTypes: [metrics]
      collectorComponentName: filter
    data:
      - key: "{{ .ComponentName }}.error_mode"
        value: "{{ .Values.ErrorMode }}"
      - key: "{{ .ComponentName }}.metrics.metric"
        value: "{{ .Values.MetricStatements | encodeAsArray }}"
        suppress_if: "{{ not .Values.MetricStatements }}"
      - key: "{{ .ComponentName }}.metrics.datapoint"
        value: "{{ .Values.DataPointStatements | encodeAsArray }}"
        suppress_if: "{{ not .Values.DataPointStatements }}"
