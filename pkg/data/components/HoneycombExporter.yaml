kind: HoneycombExporter
name: Send to Honeycomb
style: exporter
logo: honeycomb
type: base
status: alpha
version: v0.1.0
summary: Sends telemetry to Honeycomb's data store for real-time analysis.
description: |-
  This component sends traces, logs, metrics, and Honeycomb-formatted events to the Honeycomb's data
  store for real-time analysis.
tags:
  - category:output
  - service:refinery
  - signal:HoneycombEvents
  - vendor:Honeycomb
  - input:Events
  - input:Traces
  - input:Logs
  - input:Metrics
ports:
  # inputs
  - name: Events
    direction: input
    type: HoneycombEvents
  - name: Traces
    direction: input
    type: OTelTraces
  - name: Logs
    direction: input
    type: OTelLogs
  - name: Metrics
    direction: input
    type: OTelMetrics
properties:
  - name: APIKey
    summary: The Honeycomb API key or environment variable to authenticate to the ingest API.
    description: |
      The Honeycomb API key or environment variable to authenticate to the ingest API.
      For example, when sending to the US instance of Honeycomb, use a Team API key
      (starts with hcaik_). When sending to Honeycomb EU, use an Ingest key (starts with hcxik_).
      When sending to Honeycomb EU via Refinery, use a Configuration key (starts with hccik_).

      This property is deprecated in favor of the Environment property. If both are set,
      Environment takes precedence.
    type: string
  - name: Environment
    summary: The Honeycomb environment ID to send data to.
    description: |
      The Honeycomb environment ID to send data to. This is an opaque string identifier
      with a hny_ prefix (e.g., hny_abc123xyz) that identifies which environment within
      your Honeycomb account will receive the telemetry data.

      If set, this takes precedence over the APIKey property. An external service will
      replace the environment ID placeholder with the appropriate API key before the
      collector starts.
    type: string
  - name: MetricsDataset
    summary: The Honeycomb dataset metrics will be sent to.
    description: |
      The Honeycomb dataset metrics will be sent to.
      The default value is 'metrics'.
    type: string
    validations:
      - noblanks
    default: metrics
    advanced: true
  - name: APIEndpoint
    summary: The hostname or IP of the Honeycomb API endpoint.
    description: |
      The hostname or IP of the Honeycomb API endpoint
      This is normally api.honeycomb.io, but can be overridden.
    type: string
    validations:
      - noblanks
      - hostorip
    default: api.honeycomb.io
    advanced: true
  - name: APIPort
    summary: The port on which to send traffic.
    description: |
      The port on which to send outgoing traffic. Default is 443, which is
      the value expected by Honeycomb.
    type: int
    validations:
      - inrange(1, 65535)
    default: 443
    advanced: true
  - name: Insecure
    summary: Provide a way to disable TLS export.
    description: |
      Can be used to send data without TLS.
    type: bool
    subtype: label("Disable TLS export")
    default: false
    advanced: true
  - name: BatchTimeout
    summary: How long to wait to before sending a batch, regardless of size.
    description: |
      Configure how long to wait before sending a batch. The batch will be sent after
      this timeout.
    type: duration
    default: 200ms
    validations:
      - duration
      - nonempty
    advanced: true
  - name: BatchSize
    summary: The size of a batch.
    description: |
      The size of a batch, measured by span/datapoint/log record count. Once a batch reaches this size it will be sent.
    type: int
    default: 8192
    validations:
      - nonempty
    advanced: true
  - name: QueueSize
    summary: The size of a exporting queue.
    description: |
      The size of the exporting queue, measured by span/datapoint/log record count.
      Items will be kept in the queue while the batch is being created.
    type: int
    default: 100_000
    validations:
      - nonempty
    advanced: true
validations:
  - at_least_one_of(APIKey, Environment)
templates:
  - kind: refinery_config
    name: HoneycombExporter_RefineryConfig
    format: dotted
    data:
      - key: Network.HoneycombAPI
        value: "{{ buildurl .Values.Insecure .Values.APIEndpoint .Values.APIPort }}"
  - kind: collector_config
    name: honeycombexporter_collector
    format: collector
    meta:
      componentSection: exporters
      signalTypes: [traces, metrics, logs]
      collectorComponentName: otlphttp
    data:
      - key: "{{ .ComponentName }}.endpoint"
        value: "{{ buildurl .Values.Insecure .Values.APIEndpoint .Values.APIPort }}"
      - key: "{{ .ComponentName }}.tls.insecure"
        value: "{{ .Values.Insecure | encodeAsBool }}"
        suppress_if: "{{ not .Values.Insecure }}"
      - key: "{{ .ComponentName }}.headers.x-honeycomb-team"
        value: "{{ .User.TeamHeaderValue }}"
      - key: "{{ .ComponentName }}.headers.x-honeycomb-dataset"
        value: "{{ .Values.MetricsDataset }}"
      - key: "{{ .ComponentName }}.sending_queue.enabled"
        value: "{{ true | encodeAsBool}}"
      - key: "{{ .ComponentName }}.sending_queue.sizer"
        value: "items"
      - key: "{{ .ComponentName }}.sending_queue.queue_size"
        value: "{{ .Values.QueueSize | encodeAsInt }}"
      - key: "{{ .ComponentName }}.sending_queue.batch.flush_timeout"
        value: "{{ .Values.BatchTimeout }}"
      - key: "{{ .ComponentName }}.sending_queue.batch.min_size"
        value: "{{ .Values.BatchSize | encodeAsInt }}"
      - key: "{{ .ComponentName }}.sending_queue.batch.max_size"
        value: "{{ .Values.BatchSize | encodeAsInt }}"
